// {{pascalCase name}} Chart Widget
// Generated by chatgpt-apps-builder plugin
//
// A chart widget for visualizing {{name}} data
// with multiple chart type support.

import React, { useState, useEffect, useRef } from "react";
import { createRoot } from "react-dom/client";
import {
  useToolOutput,
  useWidgetState,
  useWidgetContext,
} from "../hooks";
import { cn, formatNumber, formatCurrency } from "../lib/utils";
import {
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
  Button,
  Tabs,
  TabsList,
  TabsTrigger,
  TabsContent,
  Select,
  SelectTrigger,
  SelectValue,
  SelectContent,
  SelectItem,
  Skeleton,
  SimpleLineChart,
  SimpleBarChart,
  SimpleAreaChart,
  SimplePieChart,
} from "../components/ui";
import { RefreshCw, Maximize2, Download } from "lucide-react";

// =============================================================================
// Types
// =============================================================================

interface ChartDataPoint {
  {{xAxisKey}}: string;
  {{#each metrics}}
  {{key}}: number;
  {{/each}}
}

interface ChartOutput {
  data: ChartDataPoint[];
  title?: string;
  description?: string;
  summary?: {
    {{#each metrics}}
    {{key}}Total?: number;
    {{key}}Average?: number;
    {{/each}}
  };
}

type ChartType = "line" | "bar" | "area" | "pie";

interface ChartState {
  chartType: ChartType;
  selectedMetric: string;
}

// =============================================================================
// Component
// =============================================================================

function {{pascalCase name}}ChartWidget() {
  const { theme, callTool, requestDisplayMode } = useWidgetContext();
  const toolOutput = useToolOutput<ChartOutput>();
  const [state, setState] = useWidgetState<ChartState>({
    chartType: "{{defaultChartType}}",
    selectedMetric: "{{defaultMetric}}",
  });

  const [data, setData] = useState<ChartDataPoint[]>([]);
  const [loading, setLoading] = useState(false);
  const hydratedRef = useRef(false);

  // Hydrate from tool output
  useEffect(() => {
    if (!hydratedRef.current && toolOutput?.data) {
      setData(toolOutput.data);
      hydratedRef.current = true;
    }
  }, [toolOutput]);

  const handleRefresh = async () => {
    setLoading(true);
    try {
      const result = await callTool<{ structuredContent: ChartOutput }>(
        "get-{{kebabCase name}}-data",
        {}
      );
      if (result?.structuredContent?.data) {
        setData(result.structuredContent.data);
      }
    } finally {
      setLoading(false);
    }
  };

  const handleFullscreen = async () => {
    await requestDisplayMode("fullscreen");
  };

  // Prepare data for pie chart (aggregate by metric)
  const pieData = data.length > 0
    ? [
        {{#each metrics}}
        {
          name: "{{label}}",
          value: data.reduce((sum, d) => sum + (d.{{key}} || 0), 0),
        },
        {{/each}}
      ]
    : [];

  // Chart configuration
  const chartConfig = {
    lines: [
      {{#each metrics}}
      { key: "{{key}}", name: "{{label}}"{{#if color}}, color: "{{color}}"{{/if}} },
      {{/each}}
    ],
    bars: [
      {{#each metrics}}
      { key: "{{key}}", name: "{{label}}"{{#if color}}, color: "{{color}}"{{/if}} },
      {{/each}}
    ],
    areas: [
      {{#each metrics}}
      { key: "{{key}}", name: "{{label}}"{{#if color}}, color: "{{color}}"{{/if}} },
      {{/each}}
    ],
  };

  const renderChart = () => {
    if (loading) {
      return <Skeleton className="h-[300px] w-full" />;
    }

    if (data.length === 0) {
      return (
        <div className="h-[300px] flex items-center justify-center text-muted-foreground">
          No data available
        </div>
      );
    }

    switch (state.chartType) {
      case "line":
        return (
          <SimpleLineChart
            data={data}
            xAxisKey="{{xAxisKey}}"
            lines={chartConfig.lines}
          />
        );
      case "bar":
        return (
          <SimpleBarChart
            data={data}
            xAxisKey="{{xAxisKey}}"
            bars={chartConfig.bars}
          />
        );
      case "area":
        return (
          <SimpleAreaChart
            data={data}
            xAxisKey="{{xAxisKey}}"
            areas={chartConfig.areas}
            stacked
          />
        );
      case "pie":
        return <SimplePieChart data={pieData} />;
      default:
        return null;
    }
  };

  return (
    <div className="widget-container p-4 bg-background text-foreground">
      <Card>
        <CardHeader className="pb-2">
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>{toolOutput?.title || "{{titleCase name}} Analytics"}</CardTitle>
              {toolOutput?.description && (
                <CardDescription>{toolOutput.description}</CardDescription>
              )}
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="ghost"
                size="icon"
                onClick={handleRefresh}
                disabled={loading}
              >
                <RefreshCw className={cn("h-4 w-4", loading && "animate-spin")} />
              </Button>
              <Button variant="ghost" size="icon" onClick={handleFullscreen}>
                <Maximize2 className="h-4 w-4" />
              </Button>
            </div>
          </div>
        </CardHeader>

        <CardContent>
          {/* Chart Type Selector */}
          <Tabs
            value={state.chartType}
            onValueChange={(v) => setState({ ...state, chartType: v as ChartType })}
            className="mb-4"
          >
            <TabsList>
              <TabsTrigger value="line">Line</TabsTrigger>
              <TabsTrigger value="bar">Bar</TabsTrigger>
              <TabsTrigger value="area">Area</TabsTrigger>
              <TabsTrigger value="pie">Pie</TabsTrigger>
            </TabsList>
          </Tabs>

          {/* Chart */}
          {renderChart()}

          {/* Summary Stats */}
          {toolOutput?.summary && (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-4 border-t">
              {{#each metrics}}
              <div className="text-center">
                <p className="text-2xl font-bold">
                  {formatNumber(toolOutput.summary?.{{key}}Total || 0)}
                </p>
                <p className="text-xs text-muted-foreground">Total {{label}}</p>
              </div>
              {{/each}}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

// =============================================================================
// Mount
// =============================================================================

const container = document.getElementById("{{kebabCase name}}-chart-root");
if (container) {
  const root = createRoot(container);
  root.render(<{{pascalCase name}}ChartWidget />);
}

export default {{pascalCase name}}ChartWidget;
