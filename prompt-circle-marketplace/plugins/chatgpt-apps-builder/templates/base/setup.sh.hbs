#!/bin/bash
#
# {{appName}} - Full Development Setup
#
# This script:
# - Checks prerequisites (Node.js, npm{{#if database}}, Supabase CLI, Docker{{/if}})
# - Installs npm dependencies (including dotenv)
# - Builds web assets (widgets)
# - Builds server{{#if database}}
# - Starts local Supabase
# - Applies database migrations{{/if}}
# - Creates .env file with proper configuration
#
# Usage:
#   ./setup.sh
#
set -euo pipefail

cd "$(dirname "$0")"

echo "============================================================"
echo "üöÄ {{appName}} - Development Setup"
echo "============================================================"
echo ""

# =============================================================================
# Prerequisites Check
# =============================================================================

echo "‚ñ∂ Checking prerequisites..."

if ! command -v node >/dev/null 2>&1; then
  echo "‚ùå Node.js not found. Please install Node.js 18+ first."
  echo "   https://nodejs.org/"
  exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
  echo "‚ùå Node.js 18+ required. Current version: $(node -v)"
  exit 1
fi
echo "  ‚úì Node.js $(node -v)"

if ! command -v npm >/dev/null 2>&1; then
  echo "‚ùå npm not found. Please install npm first."
  exit 1
fi
echo "  ‚úì npm $(npm -v)"

{{#if database}}
if ! command -v supabase >/dev/null 2>&1; then
  echo "‚ùå Supabase CLI not found."
  echo "   Install with: brew install supabase/tap/supabase"
  echo "   Or: npm install -g supabase"
  exit 1
fi
echo "  ‚úì Supabase CLI $(supabase --version 2>/dev/null || echo 'installed')"

if ! docker info >/dev/null 2>&1; then
  echo "‚ùå Docker is not running."
  echo "   Please start Docker Desktop first."
  exit 1
fi
echo "  ‚úì Docker is running"
{{/if}}

echo ""

# =============================================================================
# Install Dependencies
# =============================================================================

echo "‚ñ∂ Installing server dependencies..."
npm install
echo "  ‚úì Server dependencies installed"
echo ""

# Install web dependencies if web folder exists
if [ -d "web" ]; then
  echo "‚ñ∂ Installing widget dependencies (shadcn/ui, Tailwind, React)..."
  cd web
  npm install
  cd ..
  echo "  ‚úì Widget dependencies installed"
  echo ""
fi

# =============================================================================
# Build Assets
# =============================================================================

# Build widgets if web folder exists
if [ -d "web" ]; then
  echo "‚ñ∂ Building widgets (Tailwind CSS + React components)..."
  cd web
  npm run build
  cd ..
  echo "  ‚úì Widgets built to web/dist/"
  echo ""
fi

echo "‚ñ∂ Building server..."
npm run build:server
echo "  ‚úì Server built to dist/server/"
echo ""

{{#if database}}
# =============================================================================
# Database Setup (Supabase)
# =============================================================================

echo "‚ñ∂ Starting Supabase local development..."
supabase start
echo ""

# Apply migrations if supabase/migrations exists
if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations 2>/dev/null)" ]; then
  echo "‚ñ∂ Applying database migrations..."
  supabase db reset --linked=false 2>/dev/null || supabase db reset || true
  echo "  ‚úì Migrations applied"
  echo ""
fi

# Extract credentials from Supabase status
echo "‚ñ∂ Extracting Supabase credentials..."
eval $(supabase status -o env 2>/dev/null || echo "")

# Set defaults if extraction failed
API_URL="${API_URL:-http://127.0.0.1:54321}"
SERVICE_ROLE_KEY="${SERVICE_ROLE_KEY:-}"
ANON_KEY="${ANON_KEY:-}"
STUDIO_URL="${STUDIO_URL:-http://127.0.0.1:54323}"

if [ -z "$SERVICE_ROLE_KEY" ]; then
  echo "‚ö†Ô∏è  Could not extract Supabase credentials automatically."
  echo "   Run 'supabase status' and update .env manually."
fi
{{/if}}

# =============================================================================
# Create .env File
# =============================================================================

echo "‚ñ∂ Creating .env file..."

# Don't overwrite if .env exists and user hasn't confirmed
if [ -f .env ]; then
  echo "   .env already exists."
  read -p "   Overwrite? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "   Keeping existing .env"
  else
    WRITE_ENV=true
  fi
else
  WRITE_ENV=true
fi

if [ "${WRITE_ENV:-false}" = true ] || [ ! -f .env ]; then
  cat > .env << 'ENVFILE'
# {{appName}} - Environment Variables
# Generated by setup.sh on {{now}}
#
# The server uses dotenv to load these automatically.
# For local overrides, create .env.local (gitignored)

# =============================================================================
# Server Configuration
# =============================================================================
PORT=3000
HTTP_MODE=false
NODE_ENV=development

{{#if database}}
# =============================================================================
# Supabase Configuration (Local Development)
# =============================================================================
ENVFILE

  # Append Supabase values (these are dynamic)
  cat >> .env << EOF
SUPABASE_URL=${API_URL:-http://127.0.0.1:54321}
SUPABASE_SERVICE_KEY=${SERVICE_ROLE_KEY:-your-service-role-key}
SUPABASE_ANON_KEY=${ANON_KEY:-your-anon-key}
EOF

  cat >> .env << 'ENVFILE'

# For production, use your Supabase project credentials:
# SUPABASE_URL=https://your-project.supabase.co
# SUPABASE_SERVICE_KEY=your-production-service-key
{{/if}}

{{#if auth.auth0}}
# =============================================================================
# Auth0 Configuration
# =============================================================================
# AUTH0_DOMAIN=your-tenant.auth0.com
# AUTH0_CLIENT_ID=your-client-id
# AUTH0_CLIENT_SECRET=your-client-secret
{{/if}}

{{#if auth.supabase}}
# =============================================================================
# Supabase Auth
# =============================================================================
# Supabase Auth uses the SUPABASE_* variables above
{{/if}}

{{#each externalApis}}
# =============================================================================
# {{name}} Configuration
# =============================================================================
{{#each envVars}}
# {{this}}=
{{/each}}
{{/each}}
ENVFILE

  echo "  ‚úì .env file created"
fi

# =============================================================================
# Create .env.local.example
# =============================================================================

if [ ! -f .env.local.example ]; then
  cat > .env.local.example << 'EOF'
# Local Development Overrides
# Copy this to .env.local for your personal settings
# .env.local is gitignored and won't be committed

# Example: Override port for local testing
# PORT=3001

# Example: Use a different database for testing
# SUPABASE_URL=http://localhost:54321
EOF
  echo "  ‚úì .env.local.example created"
fi

# =============================================================================
# Create .gitignore entries
# =============================================================================

if ! grep -q "^\.env\.local$" .gitignore 2>/dev/null; then
  echo "" >> .gitignore
  echo "# Environment files" >> .gitignore
  echo ".env.local" >> .gitignore
  echo "  ‚úì Added .env.local to .gitignore"
fi

echo ""

# =============================================================================
# Setup Complete
# =============================================================================

echo "============================================================"
echo "‚úÖ Setup complete!"
echo "============================================================"
echo ""
{{#if database}}
echo "üì¶ Supabase is running:"
echo "   API URL: ${API_URL:-http://127.0.0.1:54321}"
echo "   Studio:  ${STUDIO_URL:-http://127.0.0.1:54323}"
echo ""
{{/if}}
echo "üìù Environment configured in .env"
echo "   The server loads environment via dotenv automatically."
echo "   Create .env.local for personal overrides (gitignored)."
echo ""
echo "üöÄ Next steps:"
echo "   ./START.sh            # Start HTTP server (for ChatGPT)"
echo "   ./START.sh --stdio    # Start for MCP Inspector"
echo "   ./START.sh --dev      # Development with hot reload"
echo ""
echo "üìö Useful commands:"
echo "   npm run build         # Rebuild everything"
echo "   npm run validate      # Run validation checks"
{{#if database}}
echo "   npm run db:status     # Check Supabase status"
echo "   npm run db:reset      # Reset database"
{{/if}}
echo ""
